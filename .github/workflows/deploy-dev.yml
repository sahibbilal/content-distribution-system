name: Deploy to Rewamp-Dev

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy dev site
    runs-on: ubuntu-latest
    environment: wpcorex-dev-env

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Add build steps here if needed (e.g., npm ci && npm run build)
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build

      - name: Check Current Directory Before FTP Deploy
        if: ${{ vars.FTP_SERVER_DEV }}
        run: |
          echo "=== Checking current directory before FTP deployment ==="
          echo "=== Current working directory (pwd) ==="
          pwd
          cd ../ && pwd && ls -la | head -10
          cd ../ && pwd && ls -la | head -10
          cd ../ && pwd && ls -la | head -10
          echo "=== Full absolute path ==="
          echo "$(pwd)"
          ls -la
          cd ../ && pwd && ls -la | head -10
          cd ../ && pwd && ls -la | head -10
          cd ../ && pwd && ls -la | head -10
          echo "=== GitHub Workspace ==="
          echo "${{ github.workspace }}"
          echo "=== Listing current directory contents ==="
          ls -la
          echo "=== Checking for composer.json ==="
          if [ ! -f composer.json ]; then
            echo "ERROR: composer.json not found in current directory!"
            echo "Current directory: $(pwd)"
            echo "Directory contents:"
            ls -la
            exit 1
          fi
          echo "✓ composer.json found successfully"
          echo "=== composer.json location: $(pwd)/composer.json ==="
          echo "=== FTP will deploy from current directory: $(pwd) ==="
          echo ""
          echo "=== Navigating back 5-6 steps to previous folders ==="
          echo "=== Step 1: Going up 1 level ==="
          cd ../ && pwd && ls -la | head -10
          echo ""
          echo "=== Step 2: Going up 2 levels ==="
          cd ../ && pwd && ls -la | head -10
          echo ""
          echo "=== Step 3: Going up 3 levels ==="
          cd ../ && pwd && ls -la | head -10
          echo ""
          echo "=== Step 4: Going up 4 levels ==="
          cd ../ && pwd && ls -la | head -10
          echo ""
          echo "=== Step 5: Going up 5 levels ==="
          cd ../ && pwd && ls -la | head -10
          echo ""
          echo "=== Step 6: Going up 6 levels ==="
          cd ../ && pwd && ls -la | head -10
          echo ""
          echo "=== Final pwd after going back 6 steps ==="
          pwd

      - name: Get Complete Server Path Information
        if: ${{ vars.FTP_SERVER_DEV && vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            echo "=== Getting Complete Server Path Information ==="
            echo ""
            echo "=== 1. Home Directory ==="
            echo "HOME: $HOME"
            echo "Full path: $(readlink -f ~ || echo $HOME)"
            echo ""
            echo "=== 2. Current Working Directory (where SSH connected) ==="
            echo "PWD: $(pwd)"
            echo "Full absolute path: $(readlink -f . || pwd)"
            echo ""
            echo "=== 3. User Information ==="
            echo "User: $(whoami)"
            echo "User ID: $(id -u)"
            echo "Group ID: $(id -g)"
            echo ""
            echo "=== 4. FTP_REMOTE_DIR_DEV Variable ==="
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            echo "FTP_REMOTE_DIR_DEV: $REMOTE_DIR"
            echo ""
            echo "=== 5. Resolving FTP_REMOTE_DIR_DEV to Absolute Path ==="
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              ABSOLUTE_REMOTE_DIR="$(pwd)"
              echo "Relative path './' resolved to: $ABSOLUTE_REMOTE_DIR"
            elif [ "$REMOTE_DIR" = "/" ]; then
              ABSOLUTE_REMOTE_DIR="/"
              echo "Root directory: $ABSOLUTE_REMOTE_DIR"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              ABSOLUTE_REMOTE_DIR="$REMOTE_DIR"
              echo "Already absolute path: $ABSOLUTE_REMOTE_DIR"
            else
              ABSOLUTE_REMOTE_DIR="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$(pwd)/$REMOTE_DIR")"
              echo "Resolved relative path: $ABSOLUTE_REMOTE_DIR"
            fi
            echo ""
            echo "=== 6. Navigating to FTP_REMOTE_DIR_DEV ==="
            if [ -d "$REMOTE_DIR" ]; then
              cd "$REMOTE_DIR" || {
                echo "WARNING: Could not cd to $REMOTE_DIR, trying to create it..."
                mkdir -p "$REMOTE_DIR" && cd "$REMOTE_DIR" || {
                  echo "ERROR: Failed to create or access directory: $REMOTE_DIR"
                  exit 1
                }
              }
              echo "Successfully changed to: $REMOTE_DIR"
            else
              echo "Directory does not exist: $REMOTE_DIR"
              echo "Will be created during FTP deployment"
            fi
            echo ""
            echo "=== 7. Complete Absolute Path After Navigation ==="
            CURRENT_PWD="$(pwd)"
            echo "Current directory (pwd): $CURRENT_PWD"
            echo "Real path (readlink -f): $(readlink -f . 2>/dev/null || echo $CURRENT_PWD)"
            echo ""
            echo "=== 8. Path Components Breakdown ==="
            IFS='/' read -ra ADDR <<< "$CURRENT_PWD"
            echo "Path components:"
            for i in "${!ADDR[@]}"; do
              if [ -n "${ADDR[$i]}" ]; then
                LEVEL_PATH="/"
                for ((j=0; j<=i; j++)); do
                  if [ -n "${ADDR[$j]}" ]; then
                    LEVEL_PATH="${LEVEL_PATH}${ADDR[$j]}/"
                  fi
                done
                echo "  Level $((i+1)): $LEVEL_PATH"
              fi
            done
            echo ""
            echo "=== 9. Directory Tree from Root (showing path to current location) ==="
            echo "Showing path from / to current directory:"
            PATH_TO_SHOW="$CURRENT_PWD"
            if [ "$PATH_TO_SHOW" != "/" ]; then
              echo "/"
              CURRENT_PATH="/"
              IFS='/' read -ra PARTS <<< "${PATH_TO_SHOW#/}"
              for part in "${PARTS[@]}"; do
                if [ -n "$part" ]; then
                  CURRENT_PATH="${CURRENT_PATH}${part}/"
                  if [ -d "$CURRENT_PATH" ]; then
                    echo "  └── $part/ ($CURRENT_PATH)"
                  else
                    echo "  └── $part/ (DOES NOT EXIST: $CURRENT_PATH)"
                  fi
                fi
              done
            else
              echo "/ (root)"
            fi
            echo ""
            echo "=== 10. Directory Contents at Current Location ==="
            ls -la
            echo ""
            echo "=== 11. Final Complete Path Summary ==="
            echo "FTP_REMOTE_DIR_DEV variable: $REMOTE_DIR"
            echo "Resolved absolute path: $CURRENT_PWD"
            echo "Full canonical path: $(readlink -f . 2>/dev/null || echo $CURRENT_PWD)"
            echo "This is where FTP will deploy files to"

      - name: Deploy via FTP (Dev)
        if: ${{ vars.FTP_SERVER_DEV }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ vars.FTP_SERVER_DEV }}
          username: ${{ vars.FTP_USERNAME_DEV }}
          password: ${{ vars.FTP_PASSWORD_DEV }}
          protocol: ${{ vars.FTP_PROTOCOL_DEV || 'ftps' }}
          local-dir: ${{ vars.FTP_LOCAL_DIR_DEV || './' }}
          server-dir: ${{ vars.FTP_REMOTE_DIR_DEV || '/' }}
          state-name: .ftp-deploy-dev-state.json
          dangerous-clean-slate: false
          exclude: |
            .git/**
            .github/**
            node_modules/**
            vendor/**
            storage/logs/**
            storage/framework/cache/**
            storage/framework/sessions/**
            storage/framework/views/**
            .env
            .env.backup
            .env.production
            **/.git*
            **/.DS_Store
            **/Thumbs.db
            .ftp-deploy-dev-state.json
          dry-run: false
          log-level: verbose

      - name: Install PHP Dependencies
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            echo "=== Current directory before cd ==="
            pwd
            echo "=== Changing to FTP_REMOTE_DIR_DEV ==="
            cd ${{ vars.FTP_REMOTE_DIR_DEV }}
            echo "=== Current directory after cd ==="
            pwd
            echo "=== Directory contents ==="
            ls -la | head -20
            echo "=== Checking composer.json ==="
            if [ ! -f composer.json ]; then
              echo "ERROR: composer.json not found!"
              exit 1
            fi
            echo "=== Removing vendor directory for clean install ==="
            rm -rf vendor
            echo "=== Clearing composer cache ==="
            composer clear-cache || true
            echo "=== Running composer install (clean) ==="
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
            if [ $? -ne 0 ]; then
              echo "ERROR: Composer install failed!"
              echo "Trying without --no-dev flag..."
              composer install --optimize-autoloader --no-interaction --prefer-dist
            fi
            echo "=== Verifying composer install ==="
            if [ ! -d vendor ]; then
              echo "ERROR: vendor directory was not created!"
              exit 1
            fi
            echo "=== Composer install completed successfully ==="

      - name: Install Node Dependencies and Build Assets
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            echo "=== Current directory before cd ==="
            pwd
            echo "=== Changing to FTP_REMOTE_DIR_DEV ==="
            cd ${{ vars.FTP_REMOTE_DIR_DEV }}
            echo "=== Current directory after cd ==="
            pwd
            echo "=== Directory contents ==="
            ls -la | head -20
            echo "=== Checking for Node.js and npm ==="
            if ! command -v node &> /dev/null; then
              echo "WARNING: Node.js is not installed or not in PATH"
              echo "Checking common locations..."
              if [ -f /usr/bin/node ]; then
                export PATH="/usr/bin:$PATH"
              elif [ -f /usr/local/bin/node ]; then
                export PATH="/usr/local/bin:$PATH"
              elif [ -f ~/.nvm/nvm.sh ]; then
                source ~/.nvm/nvm.sh
              fi
            fi
            if ! command -v npm &> /dev/null; then
              echo "ERROR: npm is not installed or not in PATH"
              echo "Node.js/npm is required to build frontend assets."
              echo "Please install Node.js on your server or build assets locally before deployment."
              echo "Current PATH: $PATH"
              echo "Skipping npm build step..."
              exit 0
            fi
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "=== Checking package.json ==="
            if [ ! -f package.json ]; then
              echo "WARNING: package.json not found, skipping npm build"
              exit 0
            fi
            echo "=== Running npm commands ==="
            npm ci --production
            npm run build
            echo "=== NPM build completed ==="

      - name: Run Laravel Setup Commands
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            echo "=== Current directory before cd ==="
            pwd
            echo "=== Changing to FTP_REMOTE_DIR_DEV ==="
            cd ${{ vars.FTP_REMOTE_DIR_DEV }}
            echo "=== Current directory after cd ==="
            pwd
            echo "=== Directory contents ==="
            ls -la | head -20
            echo "=== Running Laravel setup commands ==="
            # Set proper permissions
            echo "=== Setting file permissions ==="
            # Set directory permissions (755 for directories, 644 for files)
            find . -type d -exec chmod 755 {} \; || echo "WARNING: chmod directories failed"
            find . -type f -exec chmod 644 {} \; || echo "WARNING: chmod files failed"
            # Special permissions for storage and cache
            chmod -R 775 storage bootstrap/cache || echo "WARNING: chmod storage/cache failed"
            # Make sure public directory is accessible
            chmod -R 755 public || echo "WARNING: chmod public failed"
            # Try different chown approaches (some servers don't have www-data group)
            echo "=== Setting ownership ==="
            if command -v id &> /dev/null; then
              CURRENT_USER=$(id -un)
              CURRENT_GROUP=$(id -gn)
              echo "Current user: $CURRENT_USER, group: $CURRENT_GROUP"
              # Set ownership for storage and cache (needs write access)
              chown -R $CURRENT_USER:$CURRENT_GROUP storage bootstrap/cache 2>/dev/null || echo "WARNING: chown storage/cache failed"
              # Set ownership for public directory
              chown -R $CURRENT_USER:$CURRENT_GROUP public 2>/dev/null || echo "WARNING: chown public failed"
            else
              echo "WARNING: Cannot determine user/group, skipping chown"
            fi
            
            # Verify composer install before running artisan
            echo "=== Verifying vendor directory ==="
            if [ ! -d vendor ] || [ ! -f vendor/autoload.php ]; then
              echo "ERROR: vendor/autoload.php not found! Composer install may have failed."
              echo "Cannot run artisan commands without proper dependencies."
              exit 1
            fi
            
            # Create storage symlink if it doesn't exist
            echo "=== Creating storage symlink ==="
            if [ ! -L public/storage ]; then
              php artisan storage:link || echo "WARNING: storage:link failed"
            else
              echo "Storage symlink already exists"
            fi
            # Verify symlink
            if [ -L public/storage ]; then
              echo "Storage symlink verified: $(readlink public/storage)"
            else
              echo "WARNING: Storage symlink not found!"
            fi
            
            # Run database migrations (use --force for production)
            echo "=== Running migrations ==="
            php artisan migrate --force || echo "WARNING: Migration skipped or failed"
            
            # Clear and cache configuration
            echo "=== Clearing caches ==="
            php artisan config:clear || echo "WARNING: config:clear failed"
            php artisan cache:clear || echo "WARNING: cache:clear failed"
            php artisan route:clear || echo "WARNING: route:clear failed"
            php artisan view:clear || echo "WARNING: view:clear failed"
            
            # Optimize for production
            echo "=== Optimizing Laravel ==="
            php artisan config:cache || echo "WARNING: config:cache failed"
            php artisan route:cache || echo "WARNING: route:cache failed"
            php artisan view:cache || echo "WARNING: view:cache failed"
            php artisan optimize || echo "WARNING: optimize failed"
            
            echo "=== Verifying deployment ==="
            # Check if public/index.php exists
            if [ ! -f public/index.php ]; then
              echo "ERROR: public/index.php not found!"
              exit 1
            fi
            # Check if .htaccess exists in public
            if [ ! -f public/.htaccess ]; then
              echo "WARNING: public/.htaccess not found! This may cause 403 errors."
            else
              echo "public/.htaccess found"
            fi
            # Check if .env exists
            if [ ! -f .env ]; then
              echo "WARNING: .env file not found! Make sure it's deployed or created."
            fi
            # List public directory to verify files
            echo "=== Public directory contents ==="
            ls -la public/ | head -10
            # Check permissions on public/index.php
            echo "=== Checking public/index.php permissions ==="
            ls -la public/index.php
            
            echo "=== Laravel setup completed ==="

      - name: Restart PHP-FPM (if needed)
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV && vars.RESTART_PHP_FPM_DEV == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            sudo systemctl restart php8.2-fpm || sudo systemctl restart php-fpm || echo "PHP-FPM restart skipped"

name: Deploy to Rewamp-Dev

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy dev site
    runs-on: ubuntu-latest
    environment: wpcorex-dev-env

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Build Vue.js frontend locally (Hostinger doesn't support Node.js)
      # The built assets (public/build/) will be deployed to the server
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node Dependencies
        run: npm ci

      - name: Build Frontend Assets
        run: npm run build
        
      - name: Verify Build Output
        run: |
          echo "=== Checking build output ==="
          if [ -d "public/build" ]; then
            echo "✓ public/build directory exists"
            if [ -f "public/build/manifest.json" ]; then
              echo "✓ manifest.json found"
              echo "Build files:"
              ls -la public/build/ | head -10
              echo ""
              echo "=== Verifying build files will be deployed ==="
              echo "Checking if files exist before deployment:"
              find public/build -type f | head -10
              echo ""
              echo "Total files in build directory:"
              find public/build -type f | wc -l
            else
              echo "ERROR: manifest.json NOT found!"
              exit 1
            fi
          else
            echo "ERROR: public/build directory NOT found!"
            exit 1
          fi

      - name: Deploy Files via SSH
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          source: "."
          target: "domains/wpcorex.com/public_html/cds"
          strip_components: 0
          rm: false
          exclude: |
            .git
            .github
            node_modules
            vendor
            storage/logs
            storage/framework/cache
            storage/framework/sessions
            storage/framework/views
            .env
            .env.backup
            .env.production
            .git*
            .DS_Store
            Thumbs.db
            resources/js
            resources/css
            package.json
            package-lock.json
            vite.config.js

      - name: Install PHP Dependencies (if needed)
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          command_timeout: 300s
          script: |
            set -e
            echo "=== Check and Install PHP Dependencies ==="
            DEPLOY_PATH="domains/wpcorex.com/public_html/cds"
            cd "$DEPLOY_PATH" || {
              echo "ERROR: Failed to change to directory: $DEPLOY_PATH"
              exit 1
            }
            echo "Current directory: $(pwd)"
            echo ""
            echo "=== Verifying composer.json exists ==="
            if [ ! -f composer.json ]; then
              echo "ERROR: composer.json not found in $DEPLOY_PATH!"
              exit 1
            fi
            echo "✓ composer.json found"
            echo ""
            # Check if vendor directory exists and is valid
            if [ -d vendor ] && [ -f vendor/autoload.php ]; then
              echo "=== Vendor directory exists, checking if update is needed ==="
              # Check if composer.lock exists and compare with installed packages
              if [ -f composer.lock ]; then
                echo "Checking if dependencies need updating..."
                # Composer install is idempotent - it only installs/updates what's needed
                composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist || {
                  echo "WARNING: Composer install with --no-dev failed, trying without it..."
                  composer install --optimize-autoloader --no-interaction --prefer-dist
                }
                echo "✓ Dependencies checked/updated (only if needed)"
              else
                echo "composer.lock not found, running full install..."
                composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist || {
                  echo "WARNING: Composer install with --no-dev failed, trying without it..."
                  composer install --optimize-autoloader --no-interaction --prefer-dist
                }
              fi
            else
              echo "=== Vendor directory not found, running fresh install ==="
              composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist || {
                echo "WARNING: Composer install with --no-dev failed, trying without it..."
                composer install --optimize-autoloader --no-interaction --prefer-dist
              }
              echo "✓ Fresh installation completed"
            fi
            echo ""
            echo "=== Verifying installation ==="
            if [ ! -d vendor ] || [ ! -f vendor/autoload.php ]; then
              echo "ERROR: vendor directory was not created properly!"
              exit 1
            fi
            echo "✓ Composer dependencies are ready"

      - name: Run Database Migrations
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          command_timeout: 120s
          script: |
            DEPLOY_PATH="domains/wpcorex.com/public_html/cds"
            cd "$DEPLOY_PATH" || exit 1
            echo "=== Running Database Migrations ==="
            # Check database connection first
            php artisan db:show || echo "WARNING: db:show failed, but continuing..."
            echo ""
            echo "=== Running migrations ==="
            php artisan migrate --force || {
              echo "ERROR: Migration failed!"
              echo "Checking migration status:"
              php artisan migrate:status || true
              exit 1
            }
            echo "✓ Migrations completed successfully"
            echo ""
            echo "=== Migration status ==="
            php artisan migrate:status || echo "WARNING: Could not show migration status"

      - name: Clear Laravel Caches
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            DEPLOY_PATH="domains/wpcorex.com/public_html/cds"
            cd "$DEPLOY_PATH" || exit 1
            echo "=== Clearing Laravel caches ==="
            # Clear view cache to ensure fresh Vite tags
            php artisan view:clear || echo "WARNING: view:clear failed"
            php artisan config:clear || echo "WARNING: config:clear failed"
            php artisan cache:clear || echo "WARNING: cache:clear failed"
            echo "✓ Caches cleared"

      - name: Restart PHP-FPM (if needed)
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV && vars.RESTART_PHP_FPM_DEV == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            sudo systemctl restart php8.2-fpm || sudo systemctl restart php-fpm || echo "PHP-FPM restart skipped"

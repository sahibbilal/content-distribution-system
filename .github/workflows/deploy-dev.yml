name: Deploy to Rewamp-Dev

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy dev site
    runs-on: ubuntu-latest
    environment: wpcorex-dev-env

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Add build steps here if needed (e.g., npm ci && npm run build)
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build

      - name: Get Complete Server Path Information
        if: ${{ vars.FTP_SERVER_DEV && vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          command_timeout: 30s
          script: |
            set -e
            echo "=== Getting Complete Server Path Information ==="
            echo "=== Current Working Directory ==="
            INITIAL_PWD="$(pwd)"
            echo "PWD: $INITIAL_PWD"
            echo ""
            echo "=== FTP_REMOTE_DIR_DEV Variable ==="
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            echo "FTP_REMOTE_DIR_DEV: $REMOTE_DIR"
            echo ""
            echo "=== Resolving FTP_REMOTE_DIR_DEV to Absolute Path ==="
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              CURRENT_PWD="$INITIAL_PWD"
            elif [ "$REMOTE_DIR" = "/" ]; then
              CURRENT_PWD="/"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              CURRENT_PWD="$REMOTE_DIR"
            else
              CURRENT_PWD="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$INITIAL_PWD/$REMOTE_DIR")"
            fi
            echo "Resolved absolute path: $CURRENT_PWD"
            echo ""
            echo "=== Constructing Deployment Path: \$CURRENT_PWD/public_html/cds ==="
            DEPLOY_PATH="${CURRENT_PWD}/public_html/cds"
            echo "Deployment path: $DEPLOY_PATH"
            echo ""
            echo "=== Creating deployment directory if needed ==="
            mkdir -p "$DEPLOY_PATH" || {
              echo "ERROR: Failed to create directory: $DEPLOY_PATH"
              exit 1
            }
            echo "Directory ready: $DEPLOY_PATH"
            echo ""
            echo "=== Final Deployment Location ==="
            cd "$DEPLOY_PATH"
            FINAL_PWD="$(pwd)"
            echo "Absolute path: $FINAL_PWD"
            echo "Canonical path: $(readlink -f . 2>/dev/null || echo $FINAL_PWD)"
            echo "Deployment path confirmed: $FINAL_PWD"

      - name: Deploy via FTP (Dev)
        if: ${{ vars.FTP_SERVER_DEV }}
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ vars.FTP_SERVER_DEV }}
          username: ${{ vars.FTP_USERNAME_DEV }}
          password: ${{ vars.FTP_PASSWORD_DEV }}
          protocol: ${{ vars.FTP_PROTOCOL_DEV || 'ftps' }}
          local-dir: ${{ vars.FTP_LOCAL_DIR_DEV || './' }}
          server-dir: public_html/cds/
          state-name: .ftp-deploy-dev-state.json
          dangerous-clean-slate: false
          exclude: |
            .git/**
            .github/**
            node_modules/**
            vendor/**
            storage/logs/**
            storage/framework/cache/**
            storage/framework/sessions/**
            storage/framework/views/**
            .env
            .env.backup
            .env.production
            **/.git*
            **/.DS_Store
            **/Thumbs.db
            .ftp-deploy-dev-state.json
          dry-run: false
          log-level: verbose
        continue-on-error: false

      - name: Check FTP Deployment Location
        if: ${{ vars.FTP_SERVER_DEV && vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          command_timeout: 30s
          script: |
            echo "=== Comprehensive search for deployed files ==="
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              CURRENT_PWD="$(pwd)"
            elif [ "$REMOTE_DIR" = "/" ]; then
              CURRENT_PWD="/"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              CURRENT_PWD="$REMOTE_DIR"
            else
              CURRENT_PWD="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$(pwd)/$REMOTE_DIR")"
            fi
            EXPECTED_PATH="${CURRENT_PWD}/public_html/cds"
            echo "Expected path: $EXPECTED_PATH"
            echo "Current directory: $(pwd)"
            echo ""
            echo "=== Searching for composer.json in common locations ==="
            # Search for composer.json starting from home directory
            find ~ -name "composer.json" -type f 2>/dev/null | head -10
            echo ""
            echo "=== Searching for composer.json in public_html directories ==="
            find ~/public_html -name "composer.json" -type f 2>/dev/null | head -10
            find /home -name "composer.json" -path "*/public_html/*" -type f 2>/dev/null | head -10
            echo ""
            echo "=== Checking expected location: $EXPECTED_PATH ==="
            if [ -d "$EXPECTED_PATH" ]; then
              echo "Directory exists"
              FILE_COUNT=$(find "$EXPECTED_PATH" -maxdepth 1 -type f 2>/dev/null | wc -l)
              DIR_COUNT=$(find "$EXPECTED_PATH" -maxdepth 1 -type d 2>/dev/null | wc -l)
              echo "Files: $FILE_COUNT, Directories: $DIR_COUNT"
              if [ "$FILE_COUNT" -gt 0 ] || [ "$DIR_COUNT" -gt 2 ]; then
                echo "✓ Content found!"
                ls -la "$EXPECTED_PATH"
              else
                echo "⚠ Directory is empty"
              fi
            else
              echo "⚠ Directory does not exist"
            fi
            echo ""
            echo "=== Checking if files are in parent directories ==="
            # Check public_html root
            if [ -d "${CURRENT_PWD}/public_html" ]; then
              echo "Checking ${CURRENT_PWD}/public_html:"
              ls -la "${CURRENT_PWD}/public_html" | head -10
            fi
            # Check home directory
            if [ -d "$HOME" ]; then
              echo "Checking $HOME:"
              ls -la "$HOME" | head -10
            fi
            echo ""
            echo "=== Recent files modified in last 10 minutes ==="
            find ~ -type f -mmin -10 2>/dev/null | head -20

      - name: Verify Files Deployed via FTP
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          command_timeout: 10s
          script: |
            echo "=== Verifying files were deployed via FTP ==="
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              CURRENT_PWD="$(pwd)"
            elif [ "$REMOTE_DIR" = "/" ]; then
              CURRENT_PWD="/"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              CURRENT_PWD="$REMOTE_DIR"
            else
              CURRENT_PWD="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$(pwd)/$REMOTE_DIR")"
            fi
            DEPLOY_PATH="${CURRENT_PWD}/public_html/cds"
            echo "Checking deployment path: $DEPLOY_PATH"
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "ERROR: Deployment directory does not exist: $DEPLOY_PATH"
              exit 1
            fi
            cd "$DEPLOY_PATH"
            echo "=== Current directory: $(pwd) ==="
            echo "=== Checking for key files ==="
            if [ ! -f composer.json ]; then
              echo "ERROR: composer.json not found!"
              echo "Directory contents:"
              ls -la | head -20
              exit 1
            fi
            echo "✓ composer.json found"
            FILE_COUNT=$(find . -maxdepth 1 -type f | wc -l)
            echo "Files in root: $FILE_COUNT"
            if [ "$FILE_COUNT" -lt 5 ]; then
              echo "WARNING: Very few files found. FTP deployment may have failed."
            fi

      - name: Install PHP Dependencies
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          command_timeout: 300s
          script: |
            set -e
            echo "=== Install PHP Dependencies ==="
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              CURRENT_PWD="$(pwd)"
            elif [ "$REMOTE_DIR" = "/" ]; then
              CURRENT_PWD="/"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              CURRENT_PWD="$REMOTE_DIR"
            else
              CURRENT_PWD="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$(pwd)/$REMOTE_DIR")"
            fi
            DEPLOY_PATH="${CURRENT_PWD}/public_html/cds"
            echo "=== Changing to deployment directory: $DEPLOY_PATH ==="
            cd "$DEPLOY_PATH" || {
              echo "ERROR: Failed to change to directory: $DEPLOY_PATH"
              echo "Current directory: $(pwd)"
              exit 1
            }
            echo "Current directory: $(pwd)"
            echo ""
            echo "=== Verifying composer.json exists ==="
            if [ ! -f composer.json ]; then
              echo "ERROR: composer.json not found in $DEPLOY_PATH!"
              echo "Directory contents:"
              ls -la
              exit 1
            fi
            echo "✓ composer.json found"
            echo ""
            echo "=== Removing vendor directory for clean install ==="
            rm -rf vendor
            echo "=== Clearing composer cache ==="
            composer clear-cache || true
            echo "=== Running composer install (clean) ==="
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
            if [ $? -ne 0 ]; then
              echo "ERROR: Composer install failed!"
              echo "Trying without --no-dev flag..."
              composer install --optimize-autoloader --no-interaction --prefer-dist
            fi
            echo "=== Verifying composer install ==="
            if [ ! -d vendor ]; then
              echo "ERROR: vendor directory was not created!"
              exit 1
            fi
            echo "=== Composer install completed successfully ==="

      - name: Install Node Dependencies and Build Assets
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            echo "=== Current directory before cd ==="
            pwd
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              CURRENT_PWD="$(pwd)"
            elif [ "$REMOTE_DIR" = "/" ]; then
              CURRENT_PWD="/"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              CURRENT_PWD="$REMOTE_DIR"
            else
              CURRENT_PWD="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$(pwd)/$REMOTE_DIR")"
            fi
            DEPLOY_PATH="${CURRENT_PWD}/public_html/cds"
            echo "=== Changing to \$CURRENT_PWD/public_html/cds ==="
            echo "Deployment path: $DEPLOY_PATH"
            cd "$DEPLOY_PATH" || {
              echo "ERROR: Failed to change to directory: $DEPLOY_PATH"
              exit 1
            }
            echo "=== Current directory after cd ==="
            pwd
            echo "=== Full absolute path ==="
            echo "$(pwd)"
            echo "=== Directory contents ==="
            ls -la | head -20
            echo "=== Checking for Node.js and npm ==="
            if ! command -v node &> /dev/null; then
              echo "WARNING: Node.js is not installed or not in PATH"
              echo "Checking common locations..."
              if [ -f /usr/bin/node ]; then
                export PATH="/usr/bin:$PATH"
              elif [ -f /usr/local/bin/node ]; then
                export PATH="/usr/local/bin:$PATH"
              elif [ -f ~/.nvm/nvm.sh ]; then
                source ~/.nvm/nvm.sh
              fi
            fi
            if ! command -v npm &> /dev/null; then
              echo "ERROR: npm is not installed or not in PATH"
              echo "Node.js/npm is required to build frontend assets."
              echo "Please install Node.js on your server or build assets locally before deployment."
              echo "Current PATH: $PATH"
              echo "Skipping npm build step..."
              exit 0
            fi
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "=== Checking package.json ==="
            if [ ! -f package.json ]; then
              echo "WARNING: package.json not found, skipping npm build"
              exit 0
            fi
            echo "=== Running npm commands ==="
            npm ci --production
            npm run build
            echo "=== NPM build completed ==="

      - name: Run Laravel Setup Commands
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            echo "=== Current directory before cd ==="
            pwd
            REMOTE_DIR="${{ vars.FTP_REMOTE_DIR_DEV || '/' }}"
            if [ "$REMOTE_DIR" = "./" ] || [ "$REMOTE_DIR" = "." ]; then
              CURRENT_PWD="$(pwd)"
            elif [ "$REMOTE_DIR" = "/" ]; then
              CURRENT_PWD="/"
            elif [[ "$REMOTE_DIR" =~ ^/ ]]; then
              CURRENT_PWD="$REMOTE_DIR"
            else
              CURRENT_PWD="$(cd "$REMOTE_DIR" 2>/dev/null && pwd || echo "$(pwd)/$REMOTE_DIR")"
            fi
            DEPLOY_PATH="${CURRENT_PWD}/public_html/cds"
            echo "=== Changing to \$CURRENT_PWD/public_html/cds ==="
            echo "Deployment path: $DEPLOY_PATH"
            cd "$DEPLOY_PATH" || {
              echo "ERROR: Failed to change to directory: $DEPLOY_PATH"
              exit 1
            }
            echo "=== Current directory after cd ==="
            pwd
            echo "=== Full absolute path ==="
            echo "$(pwd)"
            echo "=== Directory contents ==="
            ls -la | head -20
            echo "=== Running Laravel setup commands ==="
            # Set proper permissions
            echo "=== Setting file permissions ==="
            # Set directory permissions (755 for directories, 644 for files)
            find . -type d -exec chmod 755 {} \; || echo "WARNING: chmod directories failed"
            find . -type f -exec chmod 644 {} \; || echo "WARNING: chmod files failed"
            # Special permissions for storage and cache
            chmod -R 775 storage bootstrap/cache || echo "WARNING: chmod storage/cache failed"
            # Make sure public directory is accessible
            chmod -R 755 public || echo "WARNING: chmod public failed"
            # Try different chown approaches (some servers don't have www-data group)
            echo "=== Setting ownership ==="
            if command -v id &> /dev/null; then
              CURRENT_USER=$(id -un)
              CURRENT_GROUP=$(id -gn)
              echo "Current user: $CURRENT_USER, group: $CURRENT_GROUP"
              # Set ownership for storage and cache (needs write access)
              chown -R $CURRENT_USER:$CURRENT_GROUP storage bootstrap/cache 2>/dev/null || echo "WARNING: chown storage/cache failed"
              # Set ownership for public directory
              chown -R $CURRENT_USER:$CURRENT_GROUP public 2>/dev/null || echo "WARNING: chown public failed"
            else
              echo "WARNING: Cannot determine user/group, skipping chown"
            fi
            
            # Verify composer install before running artisan
            echo "=== Verifying vendor directory ==="
            if [ ! -d vendor ] || [ ! -f vendor/autoload.php ]; then
              echo "ERROR: vendor/autoload.php not found! Composer install may have failed."
              echo "Cannot run artisan commands without proper dependencies."
              exit 1
            fi
            
            # Create storage symlink if it doesn't exist
            echo "=== Creating storage symlink ==="
            if [ ! -L public/storage ]; then
              php artisan storage:link || echo "WARNING: storage:link failed"
            else
              echo "Storage symlink already exists"
            fi
            # Verify symlink
            if [ -L public/storage ]; then
              echo "Storage symlink verified: $(readlink public/storage)"
            else
              echo "WARNING: Storage symlink not found!"
            fi
            
            # Run database migrations (use --force for production)
            echo "=== Running migrations ==="
            php artisan migrate --force || echo "WARNING: Migration skipped or failed"
            
            # Clear and cache configuration
            echo "=== Clearing caches ==="
            php artisan config:clear || echo "WARNING: config:clear failed"
            php artisan cache:clear || echo "WARNING: cache:clear failed"
            php artisan route:clear || echo "WARNING: route:clear failed"
            php artisan view:clear || echo "WARNING: view:clear failed"
            
            # Optimize for production
            echo "=== Optimizing Laravel ==="
            php artisan config:cache || echo "WARNING: config:cache failed"
            php artisan route:cache || echo "WARNING: route:cache failed"
            php artisan view:cache || echo "WARNING: view:cache failed"
            php artisan optimize || echo "WARNING: optimize failed"
            
            echo "=== Verifying deployment ==="
            # Check if public/index.php exists
            if [ ! -f public/index.php ]; then
              echo "ERROR: public/index.php not found!"
              exit 1
            fi
            # Check if .htaccess exists in public
            if [ ! -f public/.htaccess ]; then
              echo "WARNING: public/.htaccess not found! This may cause 403 errors."
            else
              echo "public/.htaccess found"
            fi
            # Check if .env exists
            if [ ! -f .env ]; then
              echo "WARNING: .env file not found! Make sure it's deployed or created."
            fi
            # List public directory to verify files
            echo "=== Public directory contents ==="
            ls -la public/ | head -10
            # Check permissions on public/index.php
            echo "=== Checking public/index.php permissions ==="
            ls -la public/index.php
            
            echo "=== Laravel setup completed ==="

      - name: Restart PHP-FPM (if needed)
        if: ${{ vars.SSH_HOST_DEV && vars.SSH_USERNAME_DEV && vars.RESTART_PHP_FPM_DEV == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST_DEV }}
          username: ${{ vars.SSH_USERNAME_DEV }}
          key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}
          password: ${{ secrets.SSH_PASSWORD_DEV }}
          port: ${{ vars.SSH_PORT_DEV || 22 }}
          script: |
            sudo systemctl restart php8.2-fpm || sudo systemctl restart php-fpm || echo "PHP-FPM restart skipped"
